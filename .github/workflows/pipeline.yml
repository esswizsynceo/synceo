name: CI/CD Synceo Server

on:
  push:
    branches: [ "main" ] # Se déclenche quand tu pousses sur main

jobs:
  build-and-sign:
    runs-on: windows-latest

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      # 1. Préparation de l'exécutable (Exemple Python)
      - name: Installer Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install pyinstaller
          pip install zeroconf
          pip install waitress
          pip install pystray
      - name: Debug - Vérifier les fichiers
        run: |
          dir _build
          dir _build/icons
        shell: powershell
        
      - name: Build de l'application (.exe)
        run: |
          pyinstaller --clean --onefile --noconsole `
            --name "synceo" `
            --distpath "_build/dist" `
            --add-data "_build/icons;icons" `
            --icon "_build/icons/synceo.ico" `
            "_build/synceo-release.py"

      # 2. Installation d'Inno Setup (Déjà présent sur les runners GitHub, mais on s'assure de son accès)
      - name: Compiler l'installeur avec Inno Setup
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" _build\synceo.iss
        shell: powershell

      # 3. Récupération et Signature
      - name: Décoder le certificat PFX
        shell: powershell
        run: |
          $pfx_cert_byte = [System.Convert]::FromBase64String("${{ secrets.PFX_BASE64 }}")
          [IO.File]::WriteAllBytes("${{ github.workspace }}\cert.pfx", $pfx_cert_byte)
          
      - name: Ajouter SignTool au PATH
        shell: powershell
        run: |
          $vstool = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -property installationPath
          $sdkpath = Get-ChildItem -Path "$vstool\Common7\IDE\CommonExtensions\Microsoft\TeamFoundation\Team Explorer\Git\mingw64\bin" # Alternative ou...
          # La méthode la plus fiable sur GitHub Actions :
          $signtool = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits\10\bin" -Filter signtool.exe -Recurse | Sort-Object -Descending | Select-Object -First 1
          if ($signtool) {
              $signtoolDir = $signtool.DirectoryName
              Write-Host "SignTool trouvé dans : $signtoolDir"
              echo "$signtoolDir" >> $env:GITHUB_PATH
          } else {
              Write-Error "SignTool introuvable sur le runner."
          }

      - name: Signer l'installeur
        shell: powershell
        run: |
          # SignTool est déjà dans le PATH des runners Windows de GitHub
          signtool sign /f "${{ github.workspace }}\cert.pfx" /p "${{ secrets.PFX_PASSWORD }}" /fd SHA256 /t http://timestamp.digicert.com "${{ github.workspace }}\_build\Output\SynceoSetup.exe"

      # 4. Génération du SHA256
      - name: Générer le fichier sha256.txt
        shell: powershell
        run: |
          $setupPath = "${{ github.workspace }}\_build\Output\SynceoSetup.exe"
          $hash = (Get-FileHash $setupPath -Algorithm SHA256).Hash
          "SHA256 pour SynceoSetup.exe : $hash" | Out-File "sha256.txt"

      # 5. Publication des artefacts (Téléchargeables dans l'onglet Actions)
      - name: Upload des résultats
        uses: actions/upload-artifact@v4
        with:
          name: Synceo-Server-Package
          path: |
            Output/SynceoSetup.exe
            sha256.txt