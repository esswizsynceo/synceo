name: CI/CD Synceo Server

on:
  push:
    branches: [ "main" ] # Se déclenche quand tu pousses sur main

jobs:
  build-and-sign:
    runs-on: windows-latest

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      # 1. Préparation de l'exécutable (Exemple Python)
      - name: Installer Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install pyinstaller
          pip install zeroconf
          pip install waitress
          pip install pystray
      - name: Debug - Vérifier les fichiers
        run: |
          dir _build
          dir _build/icons
        shell: powershell
        
      - name: Build de l'application (.exe)
        run: |
          pyinstaller --clean --onefile --noconsole `
            --name "synceo" `
            --distpath "_build/dist" `
            --add-data "_build/icons;icons" `
            --icon "_build/icons/synceo.ico" `
            "_build/synceo-release.py"

      # 2. Installation d'Inno Setup (Déjà présent sur les runners GitHub, mais on s'assure de son accès)
      - name: Compiler l'installeur avec Inno Setup
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" _build\synceo.iss
        shell: powershell

      # 3. Récupération et Signature
      - name: Décoder le certificat PFX
        shell: powershell
        run: |
          $pfx_cert_byte = [System.Convert]::FromBase64String("${{ secrets.PFX_BASE64 }}")
          [IO.File]::WriteAllBytes("${{ github.workspace }}\cert.pfx", $pfx_cert_byte)
          
      - name: Ajouter SignTool au PATH
        shell: powershell
        run: |
          $vstool = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -property installationPath
          $sdkpath = Get-ChildItem -Path "$vstool\Common7\IDE\CommonExtensions\Microsoft\TeamFoundation\Team Explorer\Git\mingw64\bin" # Alternative ou...
          # La méthode la plus fiable sur GitHub Actions :
          $signtool = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits\10\bin" -Filter signtool.exe -Recurse | Sort-Object -Descending | Select-Object -First 1
          if ($signtool) {
              $signtoolDir = $signtool.DirectoryName
              Write-Host "SignTool trouvé dans : $signtoolDir"
              echo "$signtoolDir" >> $env:GITHUB_PATH
          } else {
              Write-Error "SignTool introuvable sur le runner."
          }

      # 4. Génération du SHA256
     - name: Signer et Calculer le Hash
        shell: powershell
        run: |
          $setupPath = "${{ github.workspace }}\_build\Output\SynceoSetup.exe"
          
          # 1. Signature
          signtool sign /f "${{ github.workspace }}\cert.pfx" /p "${{ secrets.PFX_PASSWORD }}" /fd SHA256 /t http://timestamp.digicert.com $setupPath
          
          # 2. Calcul du SHA256 (écrase le fichier à la racine pour GitHub Pages)
          $hash = (Get-FileHash $setupPath -Algorithm SHA256).Hash
          "$hash  SynceoSetup.exe" | Out-File "${{ github.workspace }}\sha256.txt" -Encoding utf8

      # 5. Publication des artefacts (Téléchargeables dans l'onglet Actions)
      - name: 8. Mise à jour de sha256.txt sur GitHub Pages
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add sha256.txt
          git commit -m "Update SHA256: v${{ github.run_number }}" || echo "Aucun changement"
          git push

      - name: 9. Création de la Release (Se déclenche seulement si tout précède est OK)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: Synceo Server Build ${{ github.run_number }}
          body: "Mise à jour automatique. Vérifiez le fichier sha256.txt pour l'intégrité."
          files: |
            _build/Output/SynceoSetup.exe
            sha256.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}