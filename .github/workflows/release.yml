name: Build and Sign Application

on:
  push:
    tags:
      - 'v*' # Se déclenche quand tu pousses un tag (ex: v1.0)

jobs:
  build:
    runs-on: windows-latest # Obligatoire pour utiliser signtool

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install pyinstaller
          pip install zeroconf
          pip install waitress
          pip install psytrail
          pip install threading

      - name: Compile to EXE
        run: pyinstaller --clean --onefile --noconsole --name synceo--add-data "icons;icons" --icon icons/icon.ico synceo-release.py

      - name: Decode PFX
        shell: powershell
        run: |
          $pfx_cert_byte = [System.Convert]::FromBase64String("${{ secrets.PFX_BASE64 }}")
          [IO.File]::WriteAllBytes("${{ github.workspace }}\cert.pfx", $pfx_cert_byte)

      - name: Sign EXE
        shell: powershell
        run: |
          # signtool est déjà installé sur les serveurs GitHub Windows
          signtool sign /f "${{ github.workspace }}\cert.pfx" /p "${{ secrets.PFX_PASSWORD }}" /fd SHA256 /t http://timestamp.digicert.com "${{ github.workspace }}\dist\synceo.exe"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/synceo.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}